name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  # PlayGodot Integration Tests
  # Uses pre-built Godot with automation support from our fork
  playgodot-tests:
    name: PlayGodot Tests
    runs-on: ubuntu-latest
    # Can be disabled by setting ENABLE_PLAYGODOT_TESTS=false
    if: vars.ENABLE_PLAYGODOT_TESTS != 'false'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download Godot Automation Build
        run: |
          echo "=== Downloading Godot with Automation Support ==="
          mkdir -p godot-automation
          cd godot-automation
          # Download from our fork's automation-latest release
          curl -L -o godot.zip \
            "https://github.com/Randroids-Dojo/godot/releases/download/automation-latest/godot-automation-linux-x86_64.zip"
          unzip godot.zip
          chmod +x godot.linuxbsd.editor.x86_64.mono
          ls -la
          ./godot.linuxbsd.editor.x86_64.mono --version || echo "Version check requires display"

      - name: Clone PlayGodot
        run: |
          echo "=== Cloning PlayGodot ==="
          git clone --depth 1 https://github.com/Randroids-Dojo/PlayGodot.git

      - name: Install PlayGodot and test dependencies
        run: |
          cd PlayGodot/python
          pip install -e .
          pip install pytest pytest-asyncio pytest-xdist

      - name: Import Godot Project
        run: |
          echo "=== Importing Godot Project ==="
          # Use Xvfb for headless display
          xvfb-run --auto-servernum ./godot-automation/godot.linuxbsd.editor.x86_64.mono \
            --headless --import . --quit 2>&1 || true
          echo "Import complete"

      - name: Run PlayGodot Tests
        run: |
          echo "=== Running PlayGodot Integration Tests (4 parallel workers) ==="
          export GODOT_PATH="${{ github.workspace }}/godot-automation/godot.linuxbsd.editor.x86_64.mono"
          # Run with xvfb for headless display support, 4 parallel workers
          xvfb-run --auto-servernum pytest tests/ -v --tb=short -n 4
          echo "PlayGodot tests completed"

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playgodot-screenshots
          path: tests/screenshots/
          if-no-files-found: ignore

  # Build and Deploy to Vercel (production)
  build-and-deploy:
    name: Build & Deploy Web
    runs-on: ubuntu-latest
    needs: playgodot-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && vars.ENABLE_VERCEL_DEPLOY == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Godot Engine with export templates
      - name: Setup Godot Engine
        uses: chickensoft-games/setup-godot@v2
        with:
          version: 4.5.1
          use-dotnet: false
          include-templates: true

      # Import Godot project
      - name: Import Godot Project
        run: |
          timeout 60 godot --headless --import . --quit 2>&1 || true

      # Build Web export
      - name: Build Web Export
        run: |
          echo "=== Building Web Export ==="
          mkdir -p build
          godot --headless --export-release "Web" ./build/index.html 2>&1 | tee export.log
          echo ""
          echo "=== Export Output ==="
          cat export.log
          echo ""
          echo "=== Build Files ==="
          ls -la build/
          if [ -f "build/index.html" ]; then
            echo "Web build successful"
          else
            echo "Web build failed - index.html not found"
            exit 1
          fi

      # Copy Vercel config to build directory
      - name: Prepare Vercel Config
        run: |
          cp vercel.json build/

      # Upload build artifact
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/

      # Deploy to Vercel
      - name: Deploy to Vercel
        run: |
          echo "=== Deploying to Vercel ==="
          npm i -g vercel
          cd build
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --yes
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      # Build summary
      - name: Build Summary
        run: |
          echo "========================================="
          echo "        BUILD & DEPLOY SUMMARY"
          echo "========================================="
          echo ""
          echo "Web build created successfully!"
          echo ""
          echo "Build contents:"
          ls -lh build/
          echo ""
          echo "Deployed to Vercel"
          echo ""
          echo "========================================="

  # PR Preview Deployments
  preview-deploy:
    name: Deploy PR Preview
    runs-on: ubuntu-latest
    needs: playgodot-tests
    if: github.event_name == 'pull_request' && vars.ENABLE_VERCEL_DEPLOY == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Godot Engine with export templates
      - name: Setup Godot Engine
        uses: chickensoft-games/setup-godot@v2
        with:
          version: 4.5.1
          use-dotnet: false
          include-templates: true

      # Import and build
      - name: Build Web Export
        run: |
          timeout 60 godot --headless --import . --quit 2>&1 || true
          mkdir -p build
          godot --headless --export-release "Web" ./build/index.html
          cp vercel.json build/

      # Deploy preview to Vercel
      - name: Deploy Preview
        id: deploy
        run: |
          npm i -g vercel
          cd build
          url=$(vercel deploy --token=${{ secrets.VERCEL_TOKEN }} --yes)
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "Preview URL: $url"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      # Comment on PR with preview URL
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `**Preview Deployment**\n\nPlay the game: ${{ steps.deploy.outputs.url }}`
            })
